<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragment/head :: head('Administración de Juegos')"></head>

  <link
    rel="stylesheet"
    th:href="@{/assets/extensions/filepond/filepond.min.css}"
  />
  <link
    rel="stylesheet"
    th:href="@{/assets/extensions/filepond-plugin-image-preview/filepond-plugin-image-preview.css}"
  />

  <body>
    <script th:src="@{/assets/static/js/initTheme.js}"></script>
    <div id="app">
      <div id="main" class="layout-horizontal">
        <header th:replace="fragment/navbar"></header>
        <div class="content-wrapper container">
          <div class="page-heading">
            <div class="d-flex justify-content-between">
              <h3>Gestión de Videojuegos</h3>
              <a
                href="#"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addGameModal"
              >
                <i class="bi bi-plus"></i> Nuevo Juego
              </a>
            </div>
          </div>
          <div class="page-content">
            <section class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div
                      class="d-flex justify-content-between align-items-center"
                    >
                      <h4>Lista de Videojuegos</h4>
                      <div class="btn-group" role="group">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-primary active"
                          id="filter-all"
                        >
                          Todos
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-primary"
                          id="filter-published"
                        >
                          Publicados
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-primary"
                          id="filter-coming"
                        >
                          Próximamente
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-striped" id="gamesTable">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Imagen</th>
                            <th>Título</th>
                            <th>Desarrollo</th>
                            <th>Nombre Slug</th>
                            <th>Precio</th>
                            <th>Fecha Lanzamiento</th>
                            <th>Fecha Publicación</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr th:each="game : ${games}">
                            <td th:text="${game.id}">1</td>
                            <td>
                              <img
                                th:if="${thumbnails[game.id] != null}"
                                th:src="@{'/uploads/media/' + ${thumbnails[game.id]}}"
                                width="50"
                                height="50"
                                class="rounded"
                                alt="Game"
                              />
                              <img
                                th:unless="${thumbnails[game.id] != null}"
                                th:src="@{/assets/compiled/jpg/2.jpg}"
                                width="50"
                                height="50"
                                class="rounded"
                                alt="Game"
                              />
                            </td>
                            <td th:text="${game.title}">
                              The Witcher 3: Wild Hunt
                            </td>
                            <td th:text="${game.development}">
                              CD Projekt RED
                            </td>
                            <td th:text="${game.nameSlug}">Witcher 3</td>
                            <td
                              th:text="${game.price != null ? game.price + ' €' : 'No disponible'}"
                            >
                              29.99 €
                            </td>
                            <td
                              th:text="${#temporals.format(game.releaseDate, 'dd/MM/yyyy')}"
                            >
                              19/05/2015
                            </td>
                            <td>
                              <span
                                th:if="${game.isPublished()}"
                                class="badge bg-success"
                                >Publicado</span
                              >
                              <span
                                th:unless="${game.isPublished()}"
                                class="badge bg-warning"
                                th:text="${#temporals.format(game.publishedDate, 'dd/MM/yyyy')}"
                                >Próximamente</span
                              >
                            </td>
                            <td>
                              <div class="dropdown">
                                <button
                                  class="btn btn-sm dropdown-toggle"
                                  type="button"
                                  data-bs-toggle="dropdown"
                                  aria-expanded="false"
                                >
                                  <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li>
                                    <a
                                      class="dropdown-item"
                                      href="#"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editGameModal"
                                      th:data-id="${game.id}"
                                      ><i class="bi bi-pencil"></i> Editar</a
                                    >
                                  </li>
                                  <li>
                                    <a
                                      class="dropdown-item"
                                      href="#"
                                      data-bs-toggle="modal"
                                      data-bs-target="#manageGameMediaModal"
                                      th:data-title="${game.title}"
                                      th:data-id="${game.id}"
                                      ><i class="bi bi-images"></i> Gestionar
                                      Imágenes</a
                                    >
                                  </li>
                                  <li>
                                    <a
                                      class="dropdown-item"
                                      href="#"
                                      data-bs-toggle="modal"
                                      data-bs-target="#manageFeaturesModal"
                                      th:data-id="${game.id}"
                                      th:attr="data-features=${#strings.arrayJoin(game.listIdFeatures, ',')}"
                                      th:data-title="${game.title}"
                                      ><i class="bi bi-tags"></i> Gestionar
                                      Características</a
                                    >
                                  </li>
                                  <li>
                                    <a
                                      class="dropdown-item"
                                      href="#"
                                      data-bs-toggle="modal"
                                      data-bs-target="#manageEditionsModal"
                                      th:data-id="${game.id}"
                                      th:data-title="${game.title}"
                                      ><i class="bi bi-collection"></i>
                                      Gestionar Ediciones</a
                                    >
                                  </li>
                                  <li>
                                    <hr class="dropdown-divider" />
                                  </li>
                                  <li>
                                    <a
                                      class="dropdown-item text-danger"
                                      href="#"
                                      data-bs-toggle="modal"
                                      data-bs-target="#deleteGameModal"
                                      th:data-id="${game.id}"
                                      th:data-title="${game.title}"
                                      ><i class="bi bi-trash"></i> Eliminar</a
                                    >
                                  </li>
                                </ul>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </section>
            <!-- Sección Lanzamientos Próximos -->
            <section class="row mt-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h4>Calendario de Lanzamientos</h4>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Juego</th>
                            <th>Plataformas</th>
                            <th>Fecha Lanzamiento</th>
                            <th>Días Restantes</th>
                            <th>Reservas</th>
                            <th>Estado</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr
                            th:if="${upcomingGames == null || upcomingGames.empty}"
                          >
                            <td colspan="6" class="text-center">
                              No hay próximos lanzamientos programados
                            </td>
                          </tr>
                          <tr th:each="game : ${upcomingGames}">
                            <td>
                              <div class="d-flex align-items-center">
                                <div class="avatar avatar-md me-3">
                                  <img
                                    th:if="${game.thumbnail != null}"
                                    th:src="@{${game.thumbnail}}"
                                    alt="Imagen del juego"
                                  />
                                  <img
                                    th:if="${game.thumbnail == null}"
                                    th:src="@{/assets/compiled/jpg/no-image.jpg}"
                                    alt="Sin imagen"
                                  />
                                </div>
                                <div>
                                  <h6 class="mb-0" th:text="${game.title}">
                                    Título del Juego
                                  </h6>
                                  <p
                                    class="text-muted mb-0"
                                    th:text="${game.development}"
                                  >
                                    Desarrollador
                                  </p>
                                </div>
                              </div>
                            </td>
                            <td>
                              <span
                                th:if="${game.plataforms == null || game.plataforms.empty}"
                                class="badge bg-secondary"
                                >Sin plataformas</span
                              >
                              <span
                                th:each="platform : ${game.plataforms}"
                                th:class="${'badge ' + (platform.name == 'PC' ? 'bg-primary' :
                                                                (platform.name == 'PlayStation 5' ? 'bg-info' :
                                                                (platform.name == 'Xbox' ? 'bg-success' : 'bg-secondary')))}"
                                th:text="${platform.name}"
                                >Plataforma</span
                              >
                            </td>
                            <td
                              th:text="${#temporals.format(game.releaseDate, 'dd/MM/yyyy')}"
                            >
                              01/01/2025
                            </td>
                            <td
                              th:attr="data-release-date=${game.releaseDate}"
                              class="days-remaining"
                            >
                              Calculando...
                            </td>
                            <td
                              th:text="${game.reservations != null ? game.reservations.size() : '0'}"
                            >
                              0
                            </td>
                            <td>
                              <span
                                th:if="${#game.isPublished()}"
                                class="badge bg-success"
                                >Publicado</span
                              >
                              <span
                                th:unless="${#temporals.format(game.publishedDate, 'dd/MM/yyyy')}"
                                class="badge bg-warning"
                                >Próximamente</span
                              >
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

        <footer th:replace="fragment/footer"></footer>
      </div>
    </div>

    <!-- Modales -->
    <!-- Modal Añadir Juego -->
    <div
      class="modal fade"
      id="addGameModal"
      tabindex="-1"
      aria-labelledby="addGameModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addGameModalLabel">
              Añadir Nuevo Juego
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="gameTitle" class="form-label">Título</label>
                  <input
                    type="text"
                    class="form-control"
                    id="gameTitle"
                    name="title"
                    placeholder="Título del juego"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="gameDesarrollo" class="form-label"
                    >Desarrollo</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="gameDesarrollo"
                    name="desarrollo"
                    placeholder="Desarrollo del juego"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="gamePrice" class="form-label">Precio (€)</label>
                  <input
                    type="number"
                    class="form-control"
                    id="gamePrice"
                    name="price"
                    min="0"
                    step="0.01"
                    placeholder="Ej. 29.99"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="gameReleaseDate" class="form-label"
                    >Fecha de Lanzamiento</label
                  >
                  <input
                    type="text"
                    class="form-control flatpickr"
                    id="gameReleaseDate"
                    name="release_date"
                    placeholder="Seleccionar fecha"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="gameIsPublished" class="form-label"
                  >Fecha de Publicación</label
                >
                <input
                  type="text"
                  class="form-control flatpickr"
                  id="gameIsPublished"
                  name="publishedDate"
                  placeholder="Seleccionar fecha de publicación"
                />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="gameGenre" class="form-label">Género</label>
                  <select
                    class="form-select"
                    id="gameGenre"
                    name="genre"
                    required
                  >
                    <option value="" disabled selected>
                      Seleccionar género
                    </option>
                    <option th:each="genre : ${genres}" th:value="${genre.id}" th:text="${genre.name}"></option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="gameDescription" class="form-label"
                  >Descripción</label
                >
                <textarea
                  class="form-control"
                  id="gameDescription"
                  name="description"
                  rows="3"
                  required
                  placeholder="Descripción del juego (10-500 caracteres)"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary">Guardar Juego</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Juego -->
    <div
      class="modal fade"
      id="editGameModal"
      tabindex="-1"
      aria-labelledby="editGameModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editGameModalLabel">Editar Juego</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <input type="hidden" id="editGameId" name="id" />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editGameTitle" class="form-label">Título</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editGameTitle"
                    name="title"
                    placeholder="Título del juego"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editGameDesarrollo" class="form-label"
                    >Desarrollo</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="editGameDesarrollo"
                    name="desarrollo"
                    placeholder="Desarrollo del juego"
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="editGamePrice" class="form-label"
                    >Precio (€)</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="editGamePrice"
                    name="price"
                    min="0"
                    step="0.01"
                    placeholder="Ej. 29.99"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="editGameReleaseDate" class="form-label"
                    >Fecha de Lanzamiento</label
                  >
                  <input
                    type="text"
                    class="form-control flatpickr"
                    id="editGameReleaseDate"
                    name="release_date"
                    placeholder="Seleccionar fecha"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="editGameIsPublished" class="form-label"
                  >Fecha de Publicación</label
                >
                <input
                  type="text"
                  class="form-control flatpickr"
                  id="editGameIsPublished"
                  name="publishedDate"
                  placeholder="Seleccionar fecha de publicación"
                />
              </div>

              <div class="form-group">
                <label for="editGameGenre">Género</label>
                <select
                  class="form-select"
                  id="editGameGenre"
                  name="genre"
                  required
                >
                  <option value="" disabled>Seleccionar género</option>
                  <option th:each="genre : ${genres}" th:value="${genre.id}" th:text="${genre.name}"></option>
                </select>
              </div>
              <div class="form-group">
                <label for="editGameDescription">Descripción</label>
                <textarea
                  class="form-control"
                  id="editGameDescription"
                  name="description"
                  rows="3"
                  required
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer mt-4">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary">
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Gestionar Imágenes -->
    <div
      class="modal fade"
      id="manageGameMediaModal"
      tabindex="-1"
      aria-labelledby="manageGameMediaModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="manageGameMediaModalLabel">
              Gestionar Imágenes - The Witcher 3: Wild Hunt
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <h6>Imágenes Actuales</h6>
              <div class="row g-3 mb-3" id="mediaGallery"></div>
            </div>
            <div style="position: relative">
              <h6>Subir Nuevas Imágenes</h6>
              <input type="hidden" id="gameId" />
              <input
                type="file"
                class="filepond"
                name="media"
                id="gameMediaUpload"
                multiple
              />
              <small class="text-muted"
                >Puedes subir múltiples imágenes a la vez. Formatos permitidos:
                JPG, PNG, WebP. Tamaño máximo: 5MB por archivo.</small
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Gestionar Características -->
    <div
      class="modal fade"
      id="manageFeaturesModal"
      tabindex="-1"
      aria-labelledby="manageFeaturesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="manageFeaturesModalLabel">
              Gestionar Características - The Witcher 3: Wild Hunt
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="gameFeatures" class="form-label"
                >Características</label
              >
              <input type="hidden" id="gameIdFeature" />
              <select
                class="form-select fs-5"
                style="height: 220px"
                id="gameFeatures"
                multiple
              >
                <option
                  th:each="feature : ${features}"
                  th:value="${feature.id}"
                  th:text="${feature.name}"
                ></option>
              </select>
              <small class="text-muted"
                >Mantén pulsado Ctrl (Windows) o Cmd (Mac) para seleccionar
                múltiples opciones.</small
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="saveFeaturesBtn">
              Guardar Características
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Gestionar Ediciones -->
    <div
      class="modal fade"
      id="manageEditionsModal"
      tabindex="-1"
      aria-labelledby="manageEditionsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="manageEditionsModalLabel">
              Gestionar Ediciones - The Witcher 3: Wild Hunt
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h6>Ediciones Disponibles</h6>
                <button
                  type="button"
                  class="btn btn-sm btn-primary"
                  id="addEditionBtn"
                >
                  <i class="bi bi-plus"></i> Añadir Edición
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover" id="editionsTable">
                  <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Acciones</th>
                  </tr>
                  </thead>
                  <tbody id="editionsTableBody">
                  <tr>
                    <td colspan="4" class="text-center">Cargando ediciones...</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div id="addEditionForm" class="border rounded p-3 mb-3 d-none">
              <h6 class="mb-3">Añadir Nueva Edición</h6>
              <form id="newEditionForm">
                <input type="hidden" id="newEditionGameId">
                <div class="mb-3">
                  <label for="editionName" class="form-label">Nombre de la Edición</label>
                  <input type="text" class="form-control" id="editionName" placeholder="Ej. Deluxe Edition" required>
                </div>
                <div class="mb-3">
                  <label for="editionDescription" class="form-label">Descripción</label>
                  <textarea class="form-control" id="editionDescription" rows="2" placeholder="Describe el contenido de esta edición" required></textarea>
                </div>
                <div class="mb-3">
                  <label for="editionPrice" class="form-label">Precio (€)</label>
                  <input type="number" step="0.01" class="form-control" id="editionPrice" placeholder="0.00" required>
                </div>
                <div class="d-flex justify-content-end">
                  <button type="button" class="btn btn-sm btn-secondary me-2" id="cancelAddEdition">Cancelar</button>
                  <button type="button" class="btn btn-sm btn-primary" id="saveNewEditionBtn">Guardar Edición</button>
                </div>
              </form>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal Editar Edición -->
    <div class="modal fade" id="editEditionModal" tabindex="-1" aria-labelledby="editEditionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editEditionModalLabel">Editar Edición</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editEditionForm">
              <input type="hidden" id="editEditionId">
              <input type="hidden" id="editEditionGameId">
              <div class="mb-3">
                <label for="editEditionName" class="form-label">Nombre de la Edición</label>
                <input type="text" class="form-control" id="editEditionName" required>
              </div>
              <div class="mb-3">
                <label for="editEditionDescription" class="form-label">Descripción</label>
                <textarea class="form-control" id="editEditionDescription" rows="2" required></textarea>
              </div>
              <div class="mb-3">
                <label for="editEditionPrice" class="form-label">Precio (€)</label>
                <input type="number" step="0.01" class="form-control" id="editEditionPrice" required>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="saveEditEditionBtn">Guardar Cambios</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Eliminar Edición -->
    <div class="modal fade" id="deleteEditionModal" tabindex="-1" aria-labelledby="deleteEditionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteEditionModalLabel">Eliminar Edición</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem"></i>
              <h4 class="mt-3">¿Estás seguro?</h4>
              <p>¿Realmente deseas eliminar la edición <strong id="deleteEditionName"></strong>? Esta acción no se puede deshacer.</p>
            </div>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-circle"></i> Esta acción podría afectar a las ventas o reservas relacionadas con esta edición.
            </div>
            <input type="hidden" id="deleteEditionId">
            <input type="hidden" id="deleteEditionGameId">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteEditionBtn">Eliminar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal Eliminar Juego -->
    <div
      class="modal fade"
      id="deleteGameModal"
      tabindex="-1"
      aria-labelledby="deleteGameModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteGameModalLabel">
              Eliminar Juego
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <i
                class="bi bi-exclamation-triangle text-danger"
                style="font-size: 3rem"
              ></i>
              <h4 class="mt-3">¿Estás seguro?</h4>
              <p>
                ¿Realmente deseas eliminar el juego
                <strong>The Witcher 3: Wild Hunt</strong>? Esta acción no se
                puede deshacer.
              </p>
            </div>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-circle"></i> Esta acción eliminará
              todas las ediciones, imágenes y réplicas asociadas a este juego.
              Si el juego tiene ventas o reservas, considera desactivarlo en
              lugar de eliminarlo.
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-danger">Eliminar Juego</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Añadir Medio -->
    <div
      class="modal fade"
      id="addMediaModal"
      tabindex="-1"
      aria-labelledby="addMediaModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addMediaModalLabel">
              Añadir Nuevo Medio
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="mediaFile" class="form-label"
                  >Archivo de Imagen</label
                >
                <input
                  type="file"
                  class="filepond"
                  id="mediaFile"
                  name="media"
                />
                <small class="text-muted"
                  >Formatos permitidos: JPG, PNG, WebP. Tamaño máximo:
                  5MB.</small
                >
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="mediaIsThumbnail"
                  name="isThumbnail"
                />
                <label class="form-check-label" for="mediaIsThumbnail"
                  >Establecer como miniatura principal</label
                >
                <small class="d-block text-muted"
                  >Si se marca, esta imagen se usará como miniatura principal
                  del juego.</small
                >
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary">Guardar Medio</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Medio -->
    <div
      class="modal fade"
      id="editMediaModal"
      tabindex="-1"
      aria-labelledby="editMediaModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editMediaModalLabel">Editar Medio</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <input type="hidden" id="editMediaId" name="id" value="1" />
              <div class="mb-3">
                <label class="form-label">Imagen Actual</label>
                <div class="text-center mb-2">
                  <img
                    id="editMediaPreview"
                    src="./assets/compiled/jpg/1.jpg"
                    class="img-fluid rounded"
                    style="max-height: 200px"
                    alt="Media Preview"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="editMediaFile" class="form-label"
                  >Reemplazar Imagen (opcional)</label
                >
                <input
                  type="file"
                  class="filepond"
                  id="editMediaFile"
                  name="media"
                />
                <small class="text-muted"
                  >Deja vacío para mantener la imagen actual.</small
                >
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="editMediaIsThumbnail"
                  name="isThumbnail"
                  checked
                />
                <label class="form-check-label" for="editMediaIsThumbnail"
                  >Establecer como miniatura principal</label
                >
                <small class="d-block text-muted"
                  >Si se marca, esta imagen se usará como miniatura principal
                  del juego.</small
                >
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="editGameMedia">
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Eliminar Medio -->
    <div
      class="modal fade"
      id="deleteMediaModal"
      tabindex="-1"
      aria-labelledby="deleteMediaModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteMediaModalLabel">
              Eliminar Medio
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-4">
              <i
                class="bi bi-exclamation-triangle text-danger"
                style="font-size: 3rem"
              ></i>
              <h4 class="mt-3">¿Estás seguro?</h4>
              <p>
                ¿Realmente deseas eliminar esta imagen? Esta acción no se puede
                deshacer.
              </p>
              <div class="mt-3 mb-3 text-center">
                <img
                  src="./assets/compiled/jpg/1.jpg"
                  class="img-fluid rounded"
                  style="max-height: 150px"
                  alt="Media Preview"
                />
              </div>
            </div>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-circle"></i> Si eliminas la imagen
              miniatura principal, deberás establecer una nueva imagen como
              miniatura.
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="deleteGameMedia">
              Eliminar Imagen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{/assets/static/js/components/dark.js}"></script>
    <script th:src="@{/assets/static/js/pages/horizontal-layout.js}"></script>
    <script
      th:src="@{/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js}"
    ></script>
    <script th:src="@{/assets/compiled/js/app.js}"></script>
    <script th:src="@{/assets/extensions/jquery/jquery.min.js}"></script>
    <script
      th:src="@{/assets/extensions/datatables.net/js/jquery.dataTables.min.js}"
    ></script>
    <script
      th:src="@{/assets/extensions/datatables.net-bs5/js/dataTables.bootstrap5.min.js}"
    ></script>

    <!-- FilePond -->
    <script th:src="@{/assets/extensions/filepond/filepond.js}"></script>
    <script
      th:src="@{/assets/extensions/filepond-plugin-image-preview/filepond-plugin-image-preview.js}"
    ></script>
    <script
      th:src="@{/assets/extensions/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.js}"
    ></script>
    <script
      th:src="@{/assets/extensions/filepond-plugin-file-validate-size/filepond-plugin-file-validate-size.js}"
    ></script>

    <!-- Flatpickr -->
    <script th:src="@{/assets/extensions/flatpickr/flatpickr.min.js}"></script>

    <script>
      /**
       * GAME MANAGEMENT SYSTEM
       *
       * Este archivo contiene toda la lógica JavaScript para:
       * - Gestión de juegos (CRUD)
       * - Gestión de medios/imágenes
       * - Gestión de características
       * - Gestión de ediciones
       * - Filtrado y visualización de datos
       */

      document.addEventListener("DOMContentLoaded", function () {
        // Inicializar componentes
        initDataTables();
        initFilePonds();
        initFlatpickr();
        initTooltips();
        initEventListeners();
        initDaysRemainingCalculator();

        // Inicializar sistemas específicos
        initGameManagement();
        initMediaManagement();
        initFeaturesManagement();
        initEditionsManagement();
      });

      // ==============================================
      // COMPONENTES GENERALES
      // ==============================================

      function initDataTables() {
        // Tabla principal de juegos
        $("#gamesTable").DataTable({
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json",
          },
        });

        // Tabla de medios (si existe)
        if ($("#gameMediaTable").length) {
          $("#gameMediaTable").DataTable({
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json",
            },
            columnDefs: [
              { width: "10%", targets: 0 },
              { width: "15%", targets: 1 },
              { width: "50%", targets: 2 },
              { width: "10%", targets: 3 },
              { width: "15%", targets: 4 },
            ],
          });
        }
      }

      function initFilePonds() {
        // Registrar plugins
        FilePond.registerPlugin(
          FilePondPluginImagePreview,
          FilePondPluginFileValidateType,
          FilePondPluginFileValidateSize
        );

        let pondConfig = {
          acceptedFileTypes: ["image/jpeg", "image/png", "image/webp"],
          maxFileSize: "5MB",
          labelIdle:
            'Arrastra y suelta tu imagen o <span class="filepond--label-action">Buscar</span>',
          labelFileProcessing: "Subiendo...",
          labelFileProcessingComplete: "Subida completada",
          labelFileProcessingError: "Error al subir",
          labelTapToCancel: "click para cancelar",
          labelTapToRetry: "click para reintentar",
          labelTapToUndo: "click para deshacer",
          server: {
            process: {
              url: "/media",
              method: "POST",
              credentials: "include",

              ondata: (formData) => {
                formData.append("isThumbnail", false);
                return formData;
              },
              onload: (response) => {
                getMedias(gameId);
              }
              },
            },
          }
        

        // Inicializar instancias de FilePond
        const ponds = document.querySelectorAll(".filepond");
        ponds.forEach((pond) => {
          if (pond.hasAttribute("multiple")) {
            pondConfig = {
              ...pondConfig,
              instantUpload: pond.hasAttribute("multiple") ? true : false,
            };
          }
          const config = {
            ...pondConfig,
            name: "media",
            allowMultiple: pond.hasAttribute("multiple"),
            maxFiles: pond.hasAttribute("multiple") ? 6 : 1,
          };
          FilePond.create(pond, config);
        });
    }

      function initFlatpickr() {
        flatpickr(".flatpickr", {
          dateFormat: "d/m/Y",
          locale: {
            firstDayOfWeek: 1,
            weekdays: {
              shorthand: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"],
              longhand: [
                "Domingo",
                "Lunes",
                "Martes",
                "Miércoles",
                "Jueves",
                "Viernes",
                "Sábado",
              ],
            },
            months: {
              shorthand: [
                "Ene",
                "Feb",
                "Mar",
                "Abr",
                "May",
                "Jun",
                "Jul",
                "Ago",
                "Sep",
                "Oct",
                "Nov",
                "Dic",
              ],
              longhand: [
                "Enero",
                "Febrero",
                "Marzo",
                "Abril",
                "Mayo",
                "Junio",
                "Julio",
                "Agosto",
                "Septiembre",
                "Octubre",
                "Noviembre",
                "Diciembre",
              ],
            },
          },
        });
      }

      function initTooltips() {
        const tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        tooltipTriggerList.map(
          (tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
        );
      }

      function initEventListeners() {
        // Filtros de estado
        $("#filter-all").click(() => filterGames(""));
        $("#filter-published").click(() => filterGames("Publicado"));
        $("#filter-coming").click(() => filterGames("^(?!Publicado$).*$"));

        // Formulario de ediciones
        $("#addEditionBtn").click(() =>
          $("#addEditionForm").removeClass("d-none")
        );
        $("#cancelAddEdition").click(() =>
          $("#addEditionForm").addClass("d-none")
        );
      }

      function initDaysRemainingCalculator() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll(".days-remaining").forEach((cell) => {
          const releaseDateStr = cell.getAttribute("data-release-date");
          if (releaseDateStr) {
            const [year, month, day] = releaseDateStr.split("-");
            const releaseDate = new Date(year, month - 1, day);
            const diffTime = releaseDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            cell.textContent = diffDays;

            if (diffDays <= 30) {
              cell.classList.add("text-danger", "fw-bold");
            } else if (diffDays <= 90) {
              cell.classList.add("text-warning", "fw-bold");
            }
          } else {
            cell.textContent = "-";
          }
        });
      }

      // ==============================================
      // GESTIÓN DE JUEGOS
      // ==============================================

      function initGameManagement() {
        // API endpoints
        const gameApi = {
          getAll: () =>
            fetch("/api/admin/games/list").then((res) => res.json()),
          getById: (id) =>
            fetch(`/api/admin/games/${id}`).then((res) => res.json()),
          create: (game) =>
            fetch("/api/admin/games", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(game),
            }).then((res) => res.json()),
          update: (id, game) =>
            fetch(`/api/admin/games/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(game),
            }).then((res) => res.json()),
          delete: (id) => fetch(`/api/admin/games/${id}`, { method: "DELETE" }),
        };

        // Nuevo juego
        document
          .querySelector("#addGameModal .btn-primary")
          .addEventListener("click", () => {
            const game = {
              title: document.getElementById("gameTitle").value,
              development: document.getElementById("gameDesarrollo").value,
              releaseDate: parseFlatpickrDate(
                document.getElementById("gameReleaseDate").value
              ),
              publishedDate: parseFlatpickrDate(
                document.getElementById("gameIsPublished").value
              ),
              genre: {id: document.getElementById("gameGenre").value},
              description: document.getElementById("gameDescription").value,
              price: document.getElementById("gamePrice").value
                ? parseFloat(document.getElementById("gamePrice").value)
                : null,
            };

            gameApi
              .create(game)
              .then(() => {
                $("#addGameModal").modal("hide");
                showToast("Juego creado correctamente", "success");
                setTimeout(() => location.reload(), 1500);
              })
              .catch((error) => {
                console.error("Error:", error);
                showToast("Error al crear el juego", "error");
              });
          });

        // Editar juego
        document
          .querySelector("#editGameModal .btn-primary")
          .addEventListener("click", () => {
            const id = document.getElementById("editGameId").value;
            const game = {
              title: document.getElementById("editGameTitle").value,
              development: document.getElementById("editGameDesarrollo").value,
              releaseDate: parseFlatpickrDate(
                document.getElementById("editGameReleaseDate").value
              ),
              publishedDate: parseFlatpickrDate(
                document.getElementById("editGameIsPublished").value
              ),
              genre: { id: document.getElementById("editGameGenre").value },
              description: document.getElementById("editGameDescription").value,
              price: document.getElementById("editGamePrice").value
                ? parseFloat(document.getElementById("editGamePrice").value)
                : 0,
            };

            gameApi
              .update(id, game)
              .then(() => {
                $("#editGameModal").modal("hide");
                showToast("Juego actualizado correctamente", "success");
                setTimeout(() => location.reload(), 1500);
              })
              .catch((error) => {
                console.error("Error:", error);
                showToast("Error al actualizar el juego", "error");
              });
          });

        // Eliminar juego
        document
          .querySelector("#deleteGameModal .btn-danger")
          .addEventListener("click", () => {
            const id = document
              .getElementById("deleteGameModal")
              .getAttribute("data-game-id");

            gameApi
              .delete(id)
              .then(() => {
                $("#deleteGameModal").modal("hide");
                showToast("Juego eliminado correctamente", "success");
                setTimeout(() => location.reload(), 1500);
              })
              .catch((error) => {
                console.error("Error:", error);
                showToast("Error al eliminar el juego", "error");
              });
          });

        // Cargar datos para edición
        document
          .querySelectorAll('a[data-bs-target="#editGameModal"]')
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const id = this.getAttribute("data-id");

              gameApi
                .getById(id)
                .then((game) => {
                  document.getElementById("editGameId").value = game.id;
                  document.getElementById("editGameTitle").value = game.title;
                  document.getElementById("editGameDesarrollo").value =
                    game.development;
                  document.getElementById("editGamePrice").value =
                    game.price || "";
                  document.getElementById("editGameDescription").value =
                    game.description || "";

                  // Configurar género
                  const genreSelect = document.getElementById("editGameGenre");
                  Array.from(genreSelect.options).forEach((option) => {
                    option.selected = option.value === `${game.genre.id}`;
                  });

                  // Configurar fechas
                  if (game.releaseDate) {
                    document
                      .getElementById("editGameReleaseDate")
                      ._flatpickr.setDate(game.releaseDate);
                  }
                  if (game.publishedDate) {
                    document
                      .getElementById("editGameIsPublished")
                      ._flatpickr.setDate(game.publishedDate);
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  showToast("Error al cargar los datos del juego", "error");
                });
            });
          });

        // Configurar modal de eliminación
        document
          .querySelectorAll('a[data-bs-target="#deleteGameModal"]')
          .forEach((btn) => {
            btn.addEventListener("click", function () {
              const id = this.getAttribute("data-id");
              const title = this.getAttribute("data-title");

              document
                .getElementById("deleteGameModal")
                .setAttribute("data-game-id", id);
              document.querySelector("#deleteGameModal p strong").textContent =
                title;
            });
          });
      }

      // ==============================================
      // GESTIÓN DE MEDIOS
      // ==============================================

      function initMediaManagement() {
        $("#manageGameMediaModal").on("show.bs.modal", function (event) {
          const trigger = $(event.relatedTarget);
          const currentGameId = trigger.data("id");
          const currentGameTitle = trigger.data("title");

          $("#manageGameMediaModal .modal-title").text(
            `Gestionar Imágenes - ${currentGameTitle}`
          );

          $("#gameId").val(currentGameId);

          const numberGameMedia = $("#mediaGallery").children().length;

          $(".filepond").each(function () {
            const pondInstance = FilePond.find(this);
            if (pondInstance) {
              pondInstance.setOptions({
                maxFiles: 6 - numberGameMedia,
                server: {
                  process: {
                    url: "/api/admin/games/" + currentGameId + "/media",
                    method: "POST",
                    credentials: "include",
                    ondata: (formData) => {
                      formData.append("isThumbnail", false);
                      return formData;
                    },
                    onload: () => {
                      getMedias(currentGameId);
                    },
                  },
                },
              });
            }
          });

          loadGameMedia(currentGameId);
        });

        $("#editGameMedia").on("click", function (event) {
          const formData = new FormData();
          formData.append(
            "media",
            FilePond.find($("#editMediaFile")[0]).getFile()?.file
          );
          formData.append(
            "isThumbnail",
            $("#editMediaIsThumbnail").is(":checked")
          );
          const idGameMediaId = $("#editMediaId").val();

          $("#editMediaModal").modal("hide");

          putMedias(idGameMediaId, formData);
        });

        $("#deleteGameMedia").on("click", function (event) {
          const gameMediaId = $("#deleteMediaModal").attr("data-media-id");
          $("#deleteMediaModal").modal("hide");
          deleteMedia(gameMediaId);
        });
      }

      function loadGameMedia(gameId) {
        const mediaGallery = document.getElementById("mediaGallery");
        const mediaTableBody = document.querySelector("#gameMediaTable tbody");

        if (mediaGallery) mediaGallery.innerHTML = loadingSpinner();
        if (mediaTableBody)
          mediaTableBody.innerHTML = `<tr><td colspan="5">${loadingSpinner()}</td></tr>`;

        getMedias(gameId);
      }

      function renderMediaGallery(mediaList) {
        const mediaGallery = document.getElementById("mediaGallery");
        if (!mediaGallery) return;

        mediaGallery.innerHTML = mediaList
          .map(
            (media, index) => `
           <div class="col-md-4 mb-4 media-item" data-media-id="${media.id}">
               <div class="card h-100">
                   <img src="/uploads/media/${
                     media.path
                   }" class="card-img-top" alt="Media ${
              media.id
            }" style="height: 180px; object-fit: cover;">
                   <div class="p-2">
                       <div class="d-flex justify-content-between">
                           <span class="badge ${
                             media.isThumbnail ? "bg-primary" : "bg-secondary"
                           }">
                               ${media.isThumbnail ? "Miniatura" : "Imagen"}
                           </span>
                           <small class="text-muted">#${index + 1}</small>
                       </div>
                   </div>
                   <div class="card-footer bg-transparent p-2">
                       <div class="btn-group gap-2 w-100">
                           <button class="btn btn-sm btn-outline-primary edit-media-btn"
                                   data-media-id="${media.id}"
                                   data-media-url="${media.path}"
                                   data-is-thumbnail="${media.isThumbnail}">
                               <i class="bi bi-pencil"></i>
                           </button>
                           <button class="btn btn-sm btn-outline-danger delete-media-btn"
                                   data-media-id="${media.id}"
                                   data-media-url="${media.path}"
                                   data-is-thumbnail="${media.isThumbnail}">
                               <i class="bi bi-trash"></i>
                           </button>
                           ${
                             !media.isThumbnail
                               ? `
                           <button class="btn btn-sm btn-outline-success set-thumbnail-btn"
                                   data-media-id="${media.id}">
                               <i class="bi bi-star"></i>
                           </button>
                           `
                               : `
                             <button class="btn btn-sm  btn-outline-success set-thumbnail-btn"
                                   data-media-id="${media.id}">
                               <i class="bi bi-star-fill"></i>
                           </button>
                               `
                           }
                       </div>
                   </div>
               </div>
           </div>
       `
          )
          .join("");

        // Configurar eventos
        document.querySelectorAll(".edit-media-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            openEditMediaModal(
              btn.getAttribute("data-media-id"),
              btn.getAttribute("data-media-url"),
              btn.getAttribute("data-is-thumbnail") === "true"
            );
          });
        });

        document.querySelectorAll(".delete-media-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            openDeleteMediaModal(
              btn.getAttribute("data-media-id"),
              btn.getAttribute("data-media-url"),
              btn.getAttribute("data-is-thumbnail") === "true"
            );
          });
        });

        document.querySelectorAll(".set-thumbnail-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            setAsThumbnail(btn.getAttribute("data-media-id"));
          });
        });
      }

      function openEditMediaModal(mediaId, mediaUrl, isThumbnail) {
        document.getElementById("editMediaId").value = mediaId;
        document.getElementById("editMediaPreview").src =
          "/uploads/media/" + mediaUrl;
        document.getElementById("editMediaIsThumbnail").checked = isThumbnail;
        FilePond.find(document.getElementById("editMediaFile"))?.removeFiles();
        $("#editMediaModal").modal("show");
      }

      function openDeleteMediaModal(mediaId, mediaUrl, isThumbnail) {
        const modal = document.getElementById("deleteMediaModal");
        modal.querySelector(".modal-body img").src =
          "/uploads/media/" + mediaUrl;
        modal.setAttribute("data-media-id", mediaId);
        modal
          .querySelector(".alert-warning")
          .classList.toggle("d-none", !isThumbnail);
        $("#deleteMediaModal").modal("show");
      }

      function getMedias(gameId) {
        fetch("/api/admin/games/" + gameId + "/media", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            renderMediaGallery(data);
          })
          .catch((error) => {
            showToast("error", "Error en la conexión");
            console.error("Error:", error);
          });
      }

      function putMedias(gameMediaId, formData) {
        fetch("/api/admin/games/media/" + gameMediaId, {
          method: "PUT",
          body: formData,
          credentials: "include",
        })
          .then((response) => response.json())
          .then((data) => {
            getMedias($("#gameId").val());
          })
          .catch((error) => {
            showToast("error", "Error en la conexión");
            console.error("Error:", error);
          });
      }

      function deleteMedia(gameMediaId) {
        fetch("/api/admin/games/media/" + gameMediaId, {
          method: "DELETE",
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              getMedias($("#gameId").val());
            }
          })
          .catch((error) => {
            showToast("error", "Error en la conexión");
            console.error("Error:", error);
          });
      }

      function setAsThumbnail(gameMediaId) {
        fetch("/api/admin/games/media/" + gameMediaId + '/set-thumbnail', {
          method: "PUT",
          credentials: "include",
        })
          .then((response) => {
            if (response.ok) {
              getMedias($("#gameId").val());
            }
          })
          .catch((error) => {
            showToast("error", "Error en la conexión");
            console.error("Error:", error);
          });
      }

      // ==============================================
      // GESTIÓN DE CARACTERÍSTICAS
      // ==============================================

      function initFeaturesManagement() {
        const modal = document.getElementById("manageFeaturesModal");
        if (!modal) return;

        modal.addEventListener("show.bs.modal", function (event) {
          const button = event.relatedTarget;
          const gameId = button.getAttribute("data-id");
          const gameTitle = button.getAttribute("data-title");
          const featureIds = button
            .getAttribute("data-features")
            .split(",")
            .filter(Boolean);

          document.querySelector(
            "#manageFeaturesModal .modal-title"
          ).textContent = `Gestionar Características - ${gameTitle}`;
          document.getElementById("gameIdFeature").value = gameId;

          const select = document.getElementById("gameFeatures");
          Array.from(select.options).forEach((option) => {
            option.selected = featureIds.includes(option.value);
          });
        });

        document
          .getElementById("saveFeaturesBtn")
          ?.addEventListener("click", function () {
            const select = document.getElementById("gameFeatures");
            const selectedOptions = Array.from(select.selectedOptions).map(
              (opt) => opt.value
            );
            const gameId = document.getElementById("gameIdFeature").value;

            fetch(`/api/admin/games/${gameId}/features`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(selectedOptions),
            })
              .then((res) => {
                if (res.ok) {
                  showToast(
                    "success",
                    "Características guardadas correctamente"
                  );
                  $("#manageFeaturesModal").modal("hide");
                  setTimeout(() => location.reload(), 1500);
                } else {
                  showToast("error", "Error al guardar las características");
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                showToast("error", "Error en la conexión");
              });
          });
      }

      // ==============================================
      // GESTIÓN DE EDICIONES
      // ==============================================

      // ==============================================
      // FUNCIONES UTILITARIAS
      // ==============================================

      function filterGames(status) {
        const table = $("#gamesTable").DataTable();
        table.column(7).search(status, true, false).draw();
        $(".btn-outline-primary").removeClass("active");
        $(`#filter-${status.toLowerCase().replace(/ /g, "-")}`).addClass(
          "active"
        );
      }

      function showToast(message, type = "success") {
        if (typeof toastr !== "undefined") {
          toastr[type](message);
        } else {
          console.log(`${type}: ${message}`);
        }
      }

      function loadingSpinner() {
        return `
           <div class="text-center py-4">
               <div class="spinner-border text-primary" role="status">
                   <span class="visually-hidden">Cargando...</span>
               </div>
           </div>
       `;
      }

      function parseFlatpickrDate(dateString) {
        if (!dateString) return null;
        const parts = dateString.split("/");
        if (parts.length !== 3) return null;
        return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
          2,
          "0"
        )}`;
      }

      function initEditionsManagement() {
  // API endpoints para ediciones
  const editionApi = {
    getAll: (gameId) =>
      fetch(`/api/admin/games/${gameId}/editions`).then(res => res.json()),
    create: (gameId, edition) =>
      fetch(`/api/admin/games/${gameId}/editions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(edition)
      }).then(res => res.json()),
    update: (editionId, edition) =>
      fetch(`/api/admin/games/editions/${editionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(edition)
      }).then(res => res.json()),
    delete: (editionId) =>
      fetch(`/api/admin/games/editions/${editionId}`, {
        method: 'DELETE',
        credentials: 'include'
      })
  };

  // Cargar ediciones cuando se abre el modal
  $('#manageEditionsModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    const gameId = button.data('id');
    const gameTitle = button.data('title');

    // Actualizar título del modal
    $('#manageEditionsModalLabel').text(`Gestionar Ediciones - ${gameTitle}`);

    // Ocultar el formulario de añadir
    $('#addEditionForm').addClass('d-none');

    // Guardar el gameId para crear nuevas ediciones
    $('#newEditionGameId').val(gameId);

    // Cargar ediciones del juego
    loadEditions(gameId);
  });

  // Guardar nueva edición
  $('#saveNewEditionBtn').on('click', function() {
    const gameId = $('#newEditionGameId').val();
    const edition = {
      name: $('#editionName').val(),
      description: $('#editionDescription').val(),
      price: parseFloat($('#editionPrice').val())
    };

    editionApi.create(gameId, edition)
      .then(() => {
        $('#addEditionForm').addClass('d-none');
        resetEditionForm('newEditionForm');
        loadEditions(gameId);
        showToast('Edición creada correctamente', 'success');
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error al crear la edición', 'error');
      });
  });

  // Guardar edición editada
  $('#saveEditEditionBtn').on('click', function() {
    const editionId = $('#editEditionId').val();
    const gameId = $('#editEditionGameId').val();
    const edition = {
      name: $('#editEditionName').val(),
      description: $('#editEditionDescription').val(),
      price: parseFloat($('#editEditionPrice').val())
    };

    editionApi.update(editionId, edition)
      .then(() => {
        $('#editEditionModal').modal('hide');
        loadEditions(gameId);
        showToast('Edición actualizada correctamente', 'success');
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error al actualizar la edición', 'error');
      });
  });

  // Confirmar eliminación de edición
  $('#confirmDeleteEditionBtn').on('click', function() {
    const editionId = $('#deleteEditionId').val();
    const gameId = $('#deleteEditionGameId').val();

    editionApi.delete(editionId)
      .then(() => {
        $('#deleteEditionModal').modal('hide');
        loadEditions(gameId);
        showToast('Edición eliminada correctamente', 'success');
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error al eliminar la edición', 'error');
      });
  });

  // Funciones auxiliares
  function loadEditions(gameId) {
    const tableBody = document.getElementById('editionsTableBody');
    tableBody.innerHTML = `<tr><td colspan="4" class="text-center">${loadingSpinner()}</td></tr>`;

    editionApi.getAll(gameId)
      .then(editions => {
        if (editions.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center">No hay ediciones disponibles</td></tr>`;
          return;
        }

        tableBody.innerHTML = editions.map(edition => `
          <tr>
            <td>${edition.name}</td>
            <td>${edition.description.length > 50 ? edition.description.substring(0, 50) + '...' : edition.description}</td>
            <td>${edition.price.toFixed(2)} €</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-primary edit-edition-btn"
                  data-edition-id="${edition.id}"
                  data-game-id="${gameId}"
                  data-name="${edition.name}"
                  data-description="${edition.description}"
                  data-price="${edition.price}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-danger delete-edition-btn"
                  data-edition-id="${edition.id}"
                  data-game-id="${gameId}"
                  data-name="${edition.name}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        // Agregar listeners a los botones
        setupEditionEventListeners();
      })
      .catch(error => {
        console.error('Error:', error);
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error al cargar las ediciones</td></tr>`;
      });
  }

  function setupEditionEventListeners() {
    // Botones de edición
    document.querySelectorAll('.edit-edition-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const editionId = this.getAttribute('data-edition-id');
        const gameId = this.getAttribute('data-game-id');
        const name = this.getAttribute('data-name');
        const description = this.getAttribute('data-description');
        const price = this.getAttribute('data-price');

        $('#editEditionId').val(editionId);
        $('#editEditionGameId').val(gameId);
        $('#editEditionName').val(name);
        $('#editEditionDescription').val(description);
        $('#editEditionPrice').val(price);

        $('#editEditionModal').modal('show');
      });
    });

    // Botones de eliminación
    document.querySelectorAll('.delete-edition-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const editionId = this.getAttribute('data-edition-id');
        const gameId = this.getAttribute('data-game-id');
        const name = this.getAttribute('data-name');

        $('#deleteEditionId').val(editionId);
        $('#deleteEditionGameId').val(gameId);
        $('#deleteEditionName').text(name);

        $('#deleteEditionModal').modal('show');
      });
    });
  }

  function resetEditionForm(formId) {
    document.getElementById(formId).reset();
  }
}
    </script>
  </body>
</html>
